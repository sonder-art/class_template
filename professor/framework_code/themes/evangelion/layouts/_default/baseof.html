<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ============================================================================
         DOCUMENT HEAD SECTION
         Contains meta tags, external stylesheets, and library imports
         ============================================================================ -->
    
    <!-- Basic Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ if .Title }}{{ .Title }} - {{ end }}{{ .Site.Title }}</title>
    <meta name="color-scheme" content="dark light">
    
    <!-- SEO and Description Meta Tags -->
    {{ if .Description }}
        <meta name="description" content="{{ .Description }}">
    {{ else if .Summary }}
        <meta name="description" content="{{ .Summary }}">
    {{ else if .Site.Params.description }}
        <meta name="description" content="{{ .Site.Params.description }}">
    {{ end }}
    
    <!-- Framework and Theme Stylesheets -->
    {{ $mainCSS := resources.Get "css/main.css" }}
    {{ if $mainCSS }}
        <link rel="stylesheet" href="{{ $mainCSS.RelPermalink }}">
    {{ end }}
    
    {{ $themeCSS := resources.Get "theme/theme.css" }}
    {{ if $themeCSS }}
        <link rel="stylesheet" href="{{ $themeCSS.RelPermalink }}">
    {{ end }}
    
    <!-- Component Stylesheets -->
    {{ $floatingCopyCSS := resources.Get "css/floating-copy.css" }}
    {{ if $floatingCopyCSS }}
        {{ $floatingCopyCSS := $floatingCopyCSS | resources.Minify }}
        <link rel="stylesheet" href="{{ $floatingCopyCSS.RelPermalink }}">
    {{ end }}
    
    <!-- External Libraries -->
    <!-- KaTeX for LaTeX Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
    
    <!-- Pyodide for Interactive Python Execution -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    
    <!-- Prism.js for Syntax Highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Framework JavaScript Modules -->
    {{ $navigationJS := resources.Get "js/navigation.js" }}
    {{ if $navigationJS }}
        <script src="{{ $navigationJS.RelPermalink }}"></script>
    {{ end }}
    
    {{ $mathRenderingJS := resources.Get "js/math-rendering.js" }}
    {{ if $mathRenderingJS }}
        <script src="{{ $mathRenderingJS.RelPermalink }}"></script>
    {{ end }}
    
    {{ $pythonEnvJS := resources.Get "js/python-environment.js" }}
    {{ if $pythonEnvJS }}
        <script src="{{ $pythonEnvJS.RelPermalink }}"></script>
    {{ end }}
</head>
<body class="site-container{{ if .Site.Params.default_font }} font-{{ .Site.Params.default_font }}{{ end }}{{ if .Site.Params.high_contrast }} high-contrast{{ end }}">
    
    <!-- ============================================================================
         MAIN SITE STRUCTURE
         Navigation, header, main content, and footer layout
         ============================================================================ -->
    
    <!-- Mobile Navigation Toggle Button -->
    <button class="nav-toggle-btn" 
            id="navToggle" 
            aria-label="Toggle navigation menu"
            aria-expanded="true"
            aria-controls="siteNavigation">
        <span class="nav-toggle-icon">
            <span class="nav-toggle-line"></span>
            <span class="nav-toggle-line"></span>
            <span class="nav-toggle-line"></span>
        </span>
    </button>
    
    <!-- Mobile Navigation Overlay -->
    <div class="nav-overlay" id="navOverlay"></div>
    
    <!-- Site Header with Breadcrumbs and Main Navigation -->
    <header class="site-header">
        <div class="header-content">
            <h1><a href="{{ .Site.BaseURL }}">{{ .Site.Title }}</a></h1>
            
            <!-- Breadcrumb Navigation (shows when sidebar is collapsed) -->
            <nav class="breadcrumb-nav" id="breadcrumbNav">
                <span class="breadcrumb-current"></span>
            </nav>
            
            <nav class="main-nav">
                {{ range .Site.Menus.main }}
                    <a href="{{ .URL }}" {{ if $.IsMenuCurrent "main" . }}class="active"{{ end }}>{{ .Name }}</a>
                {{ end }}
            </nav>
        </div>
    </header>
    
    <!-- Site Sidebar Navigation -->
    <aside class="site-sidebar" id="siteNavigation" role="navigation">
        {{ block "sidebar" . }}
            {{ partial "sidebar-nav.html" . }}
        {{ end }}
    </aside>
    
    <!-- Main Content Area -->
    <main class="site-main content">
        {{ block "main" . }}{{ end }}
    </main>
    
    <!-- Site Footer -->
    <footer class="site-footer">
        <p>&copy; {{ now.Year }} {{ .Site.Params.course_name }} - {{ .Site.Params.professor_name }}</p>
        {{ if .Site.Params.contact_policy }}
            <p>{{ .Site.Params.contact_policy }}</p>
        {{ end }}
    </footer>


    

    
    <!-- ============================================================================
         CUSTOM CSS STYLES
         Eva theme colors, Python components, floating copy button, etc.
         TODO: Extract to external CSS files in Phase 2
         ============================================================================ -->
    <style>
    /* === LEETCODE-INSPIRED PYTHON EXECUTION UX/UI === */
    
    /* Container with CSS Grid Layout System */
    .python-exec-container {
        display: grid;
        gap: 0;
        border: 2px solid var(--eva-green-primary);
        border-radius: var(--radius-lg);
        background: var(--elevated-color);
        margin: var(--space-6) 0;
        box-shadow: var(--shadow-md);
        overflow: hidden;
        transition: all var(--transition-normal);
        min-height: 200px; /* Ensure all containers have minimum height */
    }
    
    /* Pure Code Layout (Default) */
    .python-exec-container:not(.two-column) {
        grid-template-areas: 
            "header"
            "editor" 
            "output";
        grid-template-rows: auto 1fr auto;
    }
    
    /* Two-Column Layout - Force visibility */
    .python-exec-container.two-column {
        display: grid !important;
        grid-template-areas:
            "explanation header"
            "explanation editor" 
            "output output" !important;
        grid-template-columns: 1.2fr 1fr !important;
        grid-template-rows: auto 1fr auto !important;
        gap: 2px; /* Add visible gap for debugging */
        min-height: 500px !important; /* Force visible height */
        background: #ff0000 !important; /* Temporary red background for debugging */
    }
    
    /* Header Section - Force visibility */
    .python-exec-header {
        grid-area: header !important;
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        height: var(--btn-height) !important; /* 44px - touch-friendly */
        padding: 0 var(--space-4) !important;
        background: linear-gradient(135deg, var(--eva-green-primary), var(--eva-cyan-primary)) !important;
        color: var(--bg-color) !important;
        border-bottom: 1px solid var(--border-default) !important;
        min-height: 50px !important; /* Force visible height */
    }
    
    .python-exec-label {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-weight: var(--font-semibold);
        font-size: var(--text-sm);
    }
    
    .python-icon {
        font-size: var(--text-lg);
        line-height: 1;
    }
    
    .layout-badge {
        font-size: var(--text-xs);
        padding: var(--space-1) var(--space-2);
        background: rgba(255, 255, 255, 0.2);
        border-radius: var(--radius-sm);
        margin-left: var(--space-2);
    }
    
    .python-exec-controls {
        display: flex;
        gap: var(--space-2);
    }
    
    .python-exec-button, .python-exec-clear {
        display: flex;
        align-items: center;
        gap: var(--space-1);
        padding: var(--space-2) var(--space-3);
        border: none;
        border-radius: var(--radius-sm);
        background: var(--bg-color);
        color: var(--eva-green-primary);
        font-weight: var(--font-medium);
        font-size: var(--text-xs);
        cursor: pointer;
        transition: all var(--transition-fast);
        min-height: 32px;
    }
    
    .python-exec-button:hover:not(:disabled) {
        background: var(--surface-color);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }
    
    .python-exec-clear:hover {
        background: var(--eva-red-accent);
        color: white;
        transform: translateY(-1px);
    }
    
    .python-exec-button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        background: var(--surface-color);
    }
    
    .button-icon, .button-text {
        line-height: 1;
    }
    
    /* Explanation Area (Two-Column Layout) - Force visibility */
    .python-exec-explanation {
        grid-area: explanation !important;
        padding: var(--space-4) !important;
        background: #00ff00 !important; /* Temporary green background for debugging */
        border-right: 1px solid var(--border-default) !important;
        font-size: var(--text-sm) !important;
        line-height: var(--leading-relaxed) !important;
        overflow-y: auto !important;
        max-height: 60vh !important;
        min-height: 400px !important; /* Force visible height */
        display: block !important; /* Force visibility */
        width: 100% !important;
    }
    
    .explanation-auto-content {
        width: 100% !important;
        height: 100% !important;
        display: block !important;
        background: #0000ff !important; /* Temporary blue background for debugging */
        padding: var(--space-2) !important;
    }
    
    .explanation-content {
        color: var(--text-secondary);
    }
    
    .explanation-content h2 {
        color: var(--eva-cyan-primary) !important;
        font-size: var(--text-lg) !important;
        margin: 0 0 var(--space-3) 0 !important;
        border-bottom: 1px solid var(--border-subtle);
        padding-bottom: var(--space-2);
    }
    
    .explanation-content h3 {
        color: var(--text-primary) !important;
        font-size: var(--text-base) !important;
        margin: var(--space-4) 0 var(--space-2) 0 !important;
    }
    
    .explanation-content p {
        margin: 0 0 var(--space-3) 0;
        color: var(--text-secondary);
    }
    
    .explanation-content ul, .explanation-content ol {
        margin: var(--space-2) 0;
        padding-left: var(--space-4);
    }
    
    .explanation-content li {
        margin: var(--space-1) 0;
        color: var(--text-secondary);
    }
    
    .explanation-content code {
        background: var(--code-bg) !important;
        color: var(--eva-green-primary) !important;
        padding: var(--space-1) var(--space-2) !important;
        border-radius: var(--radius-sm) !important;
        font-size: var(--text-xs) !important;
    }
    
    .explanation-content strong {
        color: var(--eva-cyan-primary);
        font-weight: var(--font-semibold);
    }
    
    .explanation-content .katex {
        font-size: 1em !important;
    }
    
    .explanation-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 250px;
        text-align: center;
        padding: var(--space-4);
    }
    
    .placeholder-icon {
        font-size: 48px;
        margin-bottom: var(--space-3);
        opacity: 0.7;
    }
    
    .explanation-placeholder h4 {
        color: var(--eva-cyan-primary) !important;
        margin: 0 0 var(--space-3) 0 !important;
        font-size: var(--text-lg) !important;
    }
    
    .explanation-placeholder p {
        color: var(--text-secondary);
        margin: 0 0 var(--space-2) 0;
        font-size: var(--text-sm);
    }
    
    .explanation-placeholder code {
        display: inline-block;
        margin: var(--space-2) 0;
        padding: var(--space-2) var(--space-3);
        background: var(--elevated-color);
        border: 1px solid var(--border-default);
        border-radius: var(--radius-sm);
        color: var(--eva-green-primary);
        font-size: var(--text-xs);
        word-break: break-all;
    }
    
    .placeholder-note {
        font-size: var(--text-xs) !important;
        color: var(--text-muted) !important;
        font-style: italic;
    }
    
    /* Code Editor Section - Force visibility */
    .python-exec-editor {
        grid-area: editor !important;
        position: relative !important;
        min-height: calc(var(--leading-normal) * var(--text-sm) * 8) !important; /* 8 lines minimum */
        max-height: 60vh !important;
        background: #1a0d26 !important; /* Deep purple coding background */
        display: block !important;
        width: 100% !important;
    }
    
    .python-code-input {
        width: 100%;
        height: 100%;
        min-height: inherit;
        max-height: inherit;
        border: none;
        outline: none;
        resize: vertical;
        padding: var(--space-4);
        margin: 0;
        
        /* Typography - VSCode Evangelion Theme */
        font-family: var(--font-mono); /* Fira Code */
        font-size: var(--text-sm);
        line-height: var(--leading-normal);
        letter-spacing: 0.025em;
        
        /* Evangelion-inspired coding colors */
        background: #1a0d26; /* Deep purple coding background */
        color: #e8e3f0; /* Light purple-white for general text */
        caret-color: #00ff41; /* Bright green cursor */
        
        /* Code styling */
        white-space: pre;
        word-wrap: normal;
        tab-size: 4;
        overflow: auto;
        
        /* Enhanced visual contrast */
        border: 1px solid #4a2c5a;
        box-shadow: inset 0 0 0 1px rgba(0, 217, 255, 0.1);
        
        /* Framework scrollbar */
        scrollbar-width: thin;
        scrollbar-color: var(--eva-green-primary) #1a0d26;
    }
    
    .python-code-input::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    .python-code-input::-webkit-scrollbar-track {
        background: #1a0d26;
    }
    
    .python-code-input::-webkit-scrollbar-thumb {
        background: var(--eva-green-primary);
        border-radius: var(--radius-sm);
    }
    
    .python-code-input::-webkit-scrollbar-thumb:hover {
        background: var(--eva-green-hover);
    }
    
    .python-code-input:focus {
        box-shadow: inset 0 0 0 2px var(--eva-green-primary), 
                   0 0 8px var(--eva-green-glow);
    }
    
    .python-code-input:focus {
        box-shadow: inset 0 0 0 2px var(--eva-green-primary), 
                   0 0 8px var(--eva-green-glow);
        border-color: var(--eva-green-primary);
    }
    
    .python-code-input::placeholder {
        color: #9CA3B8; /* Muted purple-gray */
        opacity: 0.8;
        font-style: italic;
    }
    
    /* Enhanced selection styling for better readability */
    .python-code-input::selection {
        background: var(--eva-green-primary);
        color: var(--bg-color);
    }
    
    .python-code-input::-moz-selection {
        background: var(--eva-green-primary);
        color: var(--bg-color);
    }
    
    /* Output Section */
    .python-exec-output {
        grid-area: output;
        border-top: 1px solid var(--border-default);
        background: var(--bg-color);
    }
    
    .python-exec-output-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-3) var(--space-4);
        background: var(--surface-color);
        border-bottom: 1px solid var(--border-default);
        font-weight: var(--font-medium);
        font-size: var(--text-sm);
        color: var(--eva-cyan-primary);
    }
    
    .output-icon, .output-title {
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }
    
    .output-controls {
        display: flex;
        gap: var(--space-2);
    }
    
    .output-copy {
        padding: var(--space-1) var(--space-2);
        border: 1px solid var(--border-default);
        border-radius: var(--radius-sm);
        background: var(--elevated-color);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all var(--transition-fast);
        font-size: var(--text-xs);
    }
    
    .output-copy:hover {
        background: var(--eva-green-primary);
        color: var(--bg-color);
        border-color: var(--eva-green-primary);
    }
    
    .python-exec-result {
        margin: 0;
        padding: var(--space-4);
        background: var(--bg-color);
        border: none;
        border-radius: 0;
        color: var(--text-primary);
        font-family: var(--font-mono);
        font-size: var(--text-sm);
        line-height: var(--leading-relaxed);
        white-space: pre-wrap;
        overflow-x: auto;
        max-height: 400px;
        overflow-y: auto;
        
        /* Framework scrollbar */
        scrollbar-width: thin;
        scrollbar-color: var(--eva-cyan-primary) var(--bg-color);
    }
    
    .python-exec-result::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    
    .python-exec-result::-webkit-scrollbar-track {
        background: var(--bg-color);
    }
    
    .python-exec-result::-webkit-scrollbar-thumb {
        background: var(--eva-cyan-primary);
        border-radius: var(--radius-sm);
    }
    
    /* === RESPONSIVE DESIGN === */
    
    /* Mobile: Stack vertically */
    @media (max-width: 768px) {
        .python-exec-container.two-column {
            grid-template-areas:
                "header"
                "editor"
                "explanation"
                "output";
            grid-template-columns: 1fr;
            gap: 0;
        }
        
        .python-exec-explanation {
            border-right: none;
            border-top: 1px solid var(--border-default);
            min-height: auto;
            max-height: 300px;
        }
        
        .explanation-placeholder {
            min-height: 100px;
            padding: var(--space-3);
        }
        
        .python-exec-header {
            padding: 0 var(--space-3);
        }
        
        .python-exec-controls {
            gap: var(--space-1);
        }
        
        .python-exec-button, .python-exec-clear {
            padding: var(--space-1) var(--space-2);
            font-size: var(--text-xs);
        }
        
        .button-text {
            display: none; /* Show only icons on mobile */
        }
    }
    
    /* Tablet: Adjusted proportions */
    @media (min-width: 769px) and (max-width: 1023px) {
        .python-exec-container.two-column {
            grid-template-columns: 1fr 1fr; /* Equal columns on tablet */
        }
    }
    
    /* Large screens: Optimal proportions */
    @media (min-width: 1200px) {
        .python-exec-container.two-column {
            grid-template-columns: 1.3fr 1fr; /* More space for explanation */
        }
        
        .python-exec-editor {
            min-height: calc(var(--leading-normal) * var(--text-sm) * 10); /* 10 lines on large screens */
        }
    }
    
    /* ========================================================================
       INTERACTIVE STATES & HOVER EFFECTS
       Button hover states, focus effects, and loading/error states
       ======================================================================== */
    
    .python-exec-container:hover {
        box-shadow: var(--shadow-lg);
        border-color: var(--eva-green-hover);
    }
    
    .python-exec-container:focus-within {
        box-shadow: var(--shadow-lg), var(--glow-green);
        border-color: var(--eva-green-primary);
    }
    
    /* Loading state */
    .python-exec-container.loading .python-exec-button {
        opacity: 0.7;
        cursor: not-allowed;
    }
    
    .python-exec-container.loading .python-code-input {
        opacity: 0.8;
        pointer-events: none;
    }
    
    /* Error state */
    .python-exec-container.error {
        border-color: var(--eva-red-accent);
    }
    
    .python-exec-container.error .python-exec-header {
        background: linear-gradient(135deg, var(--eva-red-accent), var(--eva-orange-accent));
    }
    

    </style>
    
    <!-- ============================================================================
         FLOATING COPY BUTTON COMPONENT
         Provides page-wide content copying with formatting preservation
         ============================================================================ -->
    <button class="floating-copy-button" id="floatingCopyBtn" title="Copy pure markdown content + code outputs">
        📝
    </button>

    <!-- ============================================================================
         FLOATING COPY FUNCTIONALITY JAVASCRIPT
         Handles content extraction, formatting, and clipboard operations
         ============================================================================ -->
    <script>
    // === PAGE CONTENT COPYING SYSTEM ===
    function copyEntirePageContent() {
        const button = document.getElementById('floatingCopyBtn');
        
        try {
            // Get the main content area
            const mainContent = document.querySelector('main.site-main') || 
                               document.querySelector('.content') || 
                               document.querySelector('main') ||
                               document.querySelector('#content');
            
            if (!mainContent) {
                console.error('Main content area not found');
                return;
            }
            
            // Convert content to formatted text
            const formattedText = htmlToFormattedText(mainContent);
            
            // Copy to clipboard
            navigator.clipboard.writeText(formattedText).then(() => {
                console.log('✅ Page content copied to clipboard');
                
                // Visual feedback
                button.classList.add('copied');
                button.innerHTML = '✅';
                
                                 setTimeout(() => {
                     button.classList.remove('copied');
                     button.innerHTML = '📝';
                 }, 2000);
                
            }).catch(err => {
                console.error('Failed to copy page content:', err);
                                 button.innerHTML = '❌';
                 setTimeout(() => {
                     button.innerHTML = '📝';
                 }, 2000);
            });
            
        } catch (error) {
            console.error('Error copying page content:', error);
        }
    }
    
    // Enhanced HTML to formatted text converter for entire pages
    function htmlToFormattedText(element) {
        let result = '';
        
        function processNode(node, indent = '') {
            if (node.nodeType === Node.TEXT_NODE) {
                const text = node.textContent.trim();
                if (text) {
                    result += text;
                }
                return;
            }
            
            if (node.nodeType !== Node.ELEMENT_NODE) return;
            
            const tagName = node.tagName.toLowerCase();
            
            // Skip navigation, headers, footers, and ALL UI elements
            if (tagName === 'nav' || tagName === 'header' || tagName === 'footer' || tagName === 'button' ||
                node.classList.contains('nav-toggle-btn') ||
                node.classList.contains('site-header') ||
                node.classList.contains('site-sidebar') ||
                node.classList.contains('site-footer') ||
                node.classList.contains('floating-copy-button') ||
                node.classList.contains('copy-code-button') ||
                node.classList.contains('copy-output-button') ||
                node.classList.contains('copy-explanation-button') ||
                node.classList.contains('copy-output-button') ||
                node.classList.contains('run-button') ||
                node.classList.contains('clear-button') ||
                node.classList.contains('python-editor-header') ||
                node.classList.contains('editor-controls') ||
                node.classList.contains('editor-title') ||
                node.classList.contains('editor-badge') ||
                node.classList.contains('explanation-header') ||
                node.classList.contains('output-placeholder')) {
                return;
            }
            
            switch (tagName) {
                case 'h1':
                    result += '\n# ';
                    processChildren(node);
                    result += '\n\n';
                    break;
                case 'h2':
                    result += '\n## ';
                    processChildren(node);
                    result += '\n\n';
                    break;
                case 'h3':
                    result += '\n### ';
                    processChildren(node);
                    result += '\n\n';
                    break;
                case 'h4':
                    result += '\n#### ';
                    processChildren(node);
                    result += '\n\n';
                    break;
                case 'h5':
                    result += '\n##### ';
                    processChildren(node);
                    result += '\n\n';
                    break;
                case 'h6':
                    result += '\n###### ';
                    processChildren(node);
                    result += '\n\n';
                    break;
                case 'p':
                    result += '\n';
                    processChildren(node);
                    result += '\n';
                    break;
                case 'strong':
                case 'b':
                    result += '**';
                    processChildren(node);
                    result += '**';
                    break;
                case 'em':
                case 'i':
                    result += '*';
                    processChildren(node);
                    result += '*';
                    break;
                case 'code':
                    if (node.parentNode && node.parentNode.tagName.toLowerCase() === 'pre') {
                        // Block code
                        result += '\n```\n';
                        processChildren(node);
                        result += '\n```\n';
                    } else {
                        // Inline code
                        result += '`';
                        processChildren(node);
                        result += '`';
                    }
                    break;
                case 'pre':
                    result += '\n';
                    processChildren(node);
                    result += '\n';
                    break;
                case 'ul':
                    result += '\n';
                    processChildren(node, indent);
                    result += '\n';
                    break;
                case 'ol':
                    result += '\n';
                    let counter = 1;
                    for (const child of node.children) {
                        if (child.tagName.toLowerCase() === 'li') {
                            result += `${indent}${counter}. `;
                            processChildren(child, indent + '   ');
                            result += '\n';
                            counter++;
                        }
                    }
                    result += '\n';
                    break;
                case 'li':
                    if (node.parentNode.tagName.toLowerCase() === 'ul') {
                        result += `${indent}- `;
                        processChildren(node, indent + '  ');
                        result += '\n';
                    }
                    break;
                case 'br':
                    result += '\n';
                    break;
                case 'hr':
                    result += '\n---\n\n';
                    break;
                case 'blockquote':
                    result += '\n> ';
                    processChildren(node);
                    result += '\n\n';
                    break;
                case 'div':
                    // Handle special components for pure markdown extraction
                    if (node.classList.contains('katex-display')) {
                        result += '\n$$' + extractMathFromKaTeX(node) + '$$\n';
                    } else if (node.classList.contains('python-lesson-container')) {
                        // Extract lesson content without UI wrappers
                        processChildren(node, indent);
                    } else if (node.classList.contains('python-editor-wrapper')) {
                        // Extract code as it would appear in markdown
                        const codeEditor = node.querySelector('.code-editor');
                        if (codeEditor) {
                            const code = codeEditor.innerText || codeEditor.textContent;
                            if (code && code.trim()) {
                                result += '\n```python\n';
                                result += code.trim();
                                result += '\n```\n\n';
                            }
                        }
                        
                        // Add output if present (as a simple code block)
                        const output = node.querySelector('.python-editor-output .success, .python-editor-output .error');
                        if (output && output.textContent.trim() && 
                            !output.textContent.includes('Output will appear') &&
                            !output.textContent.includes('Copy Output')) {
                            result += '```\n';
                            result += output.textContent.trim();
                            result += '\n```\n\n';
                        }
                    } else if (node.classList.contains('lesson-explanation')) {
                        // Extract explanation content directly
                        const explanationContent = node.querySelector('.explanation-content');
                        if (explanationContent) {
                            processChildren(explanationContent, indent);
                        } else {
                            processChildren(node, indent);
                        }
                    } else if (node.classList.contains('explanation-header')) {
                        // Skip the copy button header entirely
                        return;
                    } else if (node.classList.contains('python-editor-output') && 
                               node.querySelector('.output-placeholder')) {
                        // Skip placeholder output messages
                        return;
                    } else {
                        processChildren(node, indent);
                    }
                    break;
                case 'span':
                    if (node.classList.contains('katex')) {
                        result += '$' + extractMathFromKaTeX(node) + '$';
                    } else {
                        processChildren(node, indent);
                    }
                    break;
                default:
                    processChildren(node, indent);
                    break;
            }
        }
        
        function processChildren(node, indent = '') {
            for (const child of node.childNodes) {
                processNode(child, indent);
            }
        }
        
        function extractMathFromKaTeX(katexElement) {
            // Try to get original LaTeX from data attribute or annotation
            const annotation = katexElement.querySelector('annotation[encoding="application/x-tex"]');
            if (annotation) {
                return annotation.textContent;
            }
            
            // Fallback: try to get from title attribute or data-original
            if (katexElement.title) {
                return katexElement.title;
            }
            
            // Last resort: return the text content but clean it up
            let mathText = katexElement.textContent.trim();
            mathText = mathText.replace(/\s+/g, ' ');
            return mathText;
        }
        
        processNode(element);
        
        // Clean up extra newlines and spaces
        result = result
            .replace(/\n\s*\n\s*\n/g, '\n\n')  // Remove triple+ newlines
            .replace(/^\s+|\s+$/g, '')          // Trim start/end
            .replace(/[ \t]+/g, ' ');           // Normalize spaces
        
        return result;
    }
    
    // Initialize floating copy button
    document.addEventListener('DOMContentLoaded', function() {
        const floatingCopyBtn = document.getElementById('floatingCopyBtn');
        if (floatingCopyBtn) {
            floatingCopyBtn.addEventListener('click', copyEntirePageContent);
        }
    });
    </script>
</body>
</html> 