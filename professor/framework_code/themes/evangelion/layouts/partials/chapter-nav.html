{{/*
Chapter Navigation Partial
Displays a single chapter with its pages
*/}}

{{ $chapterName := .chapterName }}
{{ $chapterPages := .chapterPages }}
{{ $categoryName := .categoryName }}
{{ $currentPage := .currentPage }}
{{ $isAppendix := .isAppendix }}

{{/* Generate chapter title with numbering */}}
{{ $chapterTitle := $chapterName }}
{{ if $isAppendix }}
    {{ $chapterTitle = $chapterName | replaceRE "^[A-Z]_" "" | replaceRE "_" " " | title }}
    {{ $chapterTitle = printf "Appendix %s: %s" (substr $chapterName 0 1) $chapterTitle }}
{{ else }}
    {{/* Extract number and clean title for numbered chapters */}}
    {{ $chapterNumber := "" }}
    {{ $cleanTitle := $chapterName }}
    
    {{/* Check if starts with 2-digit number */}}
    {{ if and (ge (len $chapterName) 3) (and (ge (substr $chapterName 0 1) "0") (le (substr $chapterName 0 1) "9")) }}
        {{ $secondChar := substr $chapterName 1 2 }}
        {{ if and (ge $secondChar "0") (le $secondChar "9") }}
            {{ $chapterNumber = substr $chapterName 0 2 }}
            {{ $cleanTitle = substr $chapterName 3 }}
        {{ end }}
    {{ end }}
    
    {{/* Remove leading underscore and format title */}}
    {{ $cleanTitle = $cleanTitle | strings.TrimPrefix "_" | replaceRE "_" " " | title }}
    
    {{/* Combine number with title */}}
    {{ if $chapterNumber }}
        {{ $chapterTitle = printf "%s. %s" $chapterNumber $cleanTitle }}
    {{ else }}
        {{ $chapterTitle = $cleanTitle }}
    {{ end }}
{{ end }}

{{/* Check if current page is in this chapter */}}
{{ $isCurrentChapter := false }}
{{ range $chapterPages }}
    {{ if eq $currentPage.Permalink .Permalink }}
        {{ $isCurrentChapter = true }}
    {{ end }}
{{ end }}

<div class="nav-chapter {{ if $isAppendix }}nav-appendix{{ end }}">
    <div class="nav-chapter-header {{ if $isCurrentChapter }}active{{ end }}">
        {{ if $isAppendix }}
            <span class="appendix-icon">üìé</span>
        {{ else }}
            <span class="chapter-icon">üìñ</span>
        {{ end }}
        
        <button class="nav-toggle {{ if $isCurrentChapter }}expanded{{ end }}" 
                aria-expanded="{{ if $isCurrentChapter }}true{{ else }}false{{ end }}"
                data-target="{{ $categoryName }}-{{ $chapterName }}">
            <span class="toggle-icon">{{ if $isCurrentChapter }}‚ñº{{ else }}‚ñ∂{{ end }}</span>
            <span class="chapter-title">{{ $chapterTitle }}</span>
        </button>
    </div>
    
    <div class="nav-chapter-content {{ if $isCurrentChapter }}expanded{{ end }}" 
         id="{{ $categoryName }}-{{ $chapterName }}">
         
        {{/* Sort pages within chapter */}}
        {{ $regularPages := slice }}
        {{ $homeworkPages := slice }}
        {{ $indexPages := slice }}
        
        {{ range $chapterPages }}
            {{ $fileName := path.Base .File.Path }}
            {{ if hasPrefix $fileName "00_" }}
                {{ $indexPages = $indexPages | append . }}
            {{ else if hasPrefix $fileName "hw_" }}
                {{ $homeworkPages = $homeworkPages | append . }}
            {{ else }}
                {{ $regularPages = $regularPages | append . }}
            {{ end }}
        {{ end }}
        
        {{/* Sort by filename */}}
        {{ $regularPages = sort $regularPages ".File.Path" }}
        {{ $homeworkPages = sort $homeworkPages ".File.Path" }}
        {{ $indexPages = sort $indexPages ".File.Path" }}
        
        {{/* Display index first, then regular pages, then homework */}}
        {{ range $indexPages }}
            {{/* Extract numbering for index pages */}}
            {{ $pageTitle := .Title }}
            {{ $fileName := path.Base .File.Path }}
            {{ $fileNumber := "" }}
            
            {{/* Check for 00_ prefix (index files) */}}
            {{ if hasPrefix $fileName "00_" }}
                {{ $fileNumber = "üìã " }}
            {{ end }}
            
            <a href="{{ .Permalink }}" class="nav-page nav-index {{ if eq $currentPage.Permalink .Permalink }}active{{ end }}">
                <span class="page-icon">üìã</span>
                <span class="page-title">{{ $fileNumber }}{{ $pageTitle }}</span>
            </a>
        {{ end }}
        
        {{ range $regularPages }}
            {{/* Extract numbering for regular pages */}}
            {{ $pageTitle := .Title }}
            {{ $fileName := path.Base .File.Path }}
            {{ $fileNumber := "" }}
            {{ $cleanTitle := $pageTitle }}
            
            {{/* Extract number from filename */}}
            {{ if and (ge (len $fileName) 3) (and (ge (substr $fileName 0 1) "0") (le (substr $fileName 0 1) "9")) }}
                {{ $secondChar := substr $fileName 1 2 }}
                {{ if and (ge $secondChar "0") (le $secondChar "9") }}
                    {{ $fileNumber = substr $fileName 0 2 }}
                    {{ $cleanTitle = printf "%s. %s" $fileNumber $pageTitle }}
                {{ end }}
            {{ end }}
            
            <a href="{{ .Permalink }}" class="nav-page {{ if eq $currentPage.Permalink .Permalink }}active{{ end }}">
                {{ if .Params.difficulty }}
                    {{ if eq .Params.difficulty "easy" }}
                        <span class="page-icon difficulty-easy">üü¢</span>
                    {{ else if eq .Params.difficulty "medium" }}
                        <span class="page-icon difficulty-medium">üü°</span>
                    {{ else if eq .Params.difficulty "hard" }}
                        <span class="page-icon difficulty-hard">üî¥</span>
                    {{ else }}
                        <span class="page-icon">üìÑ</span>
                    {{ end }}
                {{ else }}
                    <span class="page-icon">üìÑ</span>
                {{ end }}
                <span class="page-title">{{ $cleanTitle }}</span>
                {{ if and $currentPage.Site.Params.show_estimated_time .Params.estimated_time }}
                    <span class="page-time">{{ .Params.estimated_time }}min</span>
                {{ end }}
            </a>
        {{ end }}
        
        {{ if $homeworkPages }}
            <div class="homework-section">
                <span class="homework-header">üìù Homework</span>
                {{ range $homeworkPages }}
                    {{/* Extract numbering for homework pages */}}
                    {{ $pageTitle := .Title }}
                    {{ $fileName := path.Base .File.Path }}
                    {{ $cleanTitle := $pageTitle }}
                    
                    {{/* Extract homework number (hw_01, hw_02, etc.) */}}
                    {{ if hasPrefix $fileName "hw_" }}
                        {{ $hwNumber := "" }}
                        {{ $remainingName := strings.TrimPrefix $fileName "hw_" }}
                        {{ if and (ge (len $remainingName) 2) (and (ge (substr $remainingName 0 1) "0") (le (substr $remainingName 0 1) "9")) }}
                            {{ $secondChar := substr $remainingName 1 2 }}
                            {{ if and (ge $secondChar "0") (le $secondChar "9") }}
                                {{ $hwNumber = substr $remainingName 0 2 }}
                                {{ $cleanTitle = printf "HW %s: %s" $hwNumber $pageTitle }}
                            {{ end }}
                        {{ end }}
                    {{ end }}
                    
                    <a href="{{ .Permalink }}" class="nav-page nav-homework {{ if eq $currentPage.Permalink .Permalink }}active{{ end }}">
                        <span class="page-icon">üìù</span>
                        <span class="page-title">{{ $cleanTitle }}</span>
                        {{ if and $currentPage.Site.Params.show_estimated_time .Params.estimated_time }}
                            <span class="page-time">{{ .Params.estimated_time }}min</span>
                        {{ end }}
                    </a>
                {{ end }}
            </div>
        {{ end }}
    </div>
</div> 