{{/*
Dynamic Sidebar Navigation for GitHub Class Template Framework
Automatically generates navigation tree from content structure including:
- Numbered chapters (01_, 02_, etc.) 
- Appendix chapters (A_, B_, etc.)
- Current page highlighting
- Collapsible sections
*/}}

<nav class="sidebar-nav">
    <!-- Profile Section -->
    <div class="nav-profile">
        <div class="profile-image">
            {{ $profileImage := .Site.Params.profile_image | default "/assets/images/profile-placeholder.svg" }}
            <img src="{{ $profileImage }}" alt="{{ .Site.Params.professor_name | default "Instructor" }}" class="profile-avatar">
        </div>
        <div class="profile-info">
            <h3 class="profile-name">{{ .Site.Params.professor_name | default "Instructor" }}</h3>
            <p class="profile-role">{{ .Site.Params.course_name | default "Course" }}</p>
        </div>
    </div>
    
    <!-- Utility Icons -->
    <div class="nav-utilities">
        <a href="/" class="utility-btn" title="Home">
            <span class="utility-icon">üè†</span>
        </a>
        <button class="utility-btn" title="Search (Coming Soon)" disabled>
            <span class="utility-icon">üîç</span>
        </button>
        <button class="utility-btn" title="Font Settings (Coming Soon)" disabled>
            <span class="utility-icon">üî§</span>
        </button>
    </div>
    

    
    {{/* Simple VSCode-style file tree */}}
    {{ $categories := slice "class_notes" "framework_tutorials" "framework_documentation" }}
    
    <div class="file-tree">
        {{ range $categories }}
            {{ $categoryName := . }}
            {{ $categoryPages := where $.Site.RegularPages "Section" $categoryName }}
            
            {{ if $categoryPages }}
                {{ $categoryTitle := $categoryName | replaceRE "_" " " | title }}
                
                {{/* Category Folder */}}
                <div class="folder-item" data-category="{{ $categoryName }}">
                    <div class="folder-header" data-target="category-{{ $categoryName }}">
                        <span class="folder-icon">‚ñ∂</span>
                        <a href="/{{ $categoryName }}/00_master_index/" class="folder-name-link {{ if and (eq $.Section $categoryName) (eq $.File.BaseFileName "00_master_index") }}active{{ end }}">
                            <span class="folder-name">{{ $categoryTitle }}</span>
                        </a>
                    </div>
                    
                    <div class="folder-content" id="category-{{ $categoryName }}">
                
                        {{/* Simple chapter listing with proper numeric sorting */}}
                        {{ $chapterDirs := slice }}
                        {{ range $categoryPages }}
                            {{ $dir := path.Dir .File.Path }}
                            {{ $dirName := path.Base $dir }}
                            {{ if ne $dirName $categoryName }}
                                {{ if not (in $chapterDirs $dirName) }}
                                    {{ $chapterDirs = $chapterDirs | append $dirName }}
                                {{ end }}
                            {{ end }}
                        {{ end }}
                        
                        {{/* Separate numbered chapters from appendix chapters for proper sorting */}}
                        {{ $numberedChapters := slice }}
                        {{ $appendixChapters := slice }}
                        
                        {{ range $chapterDirs }}
                            {{ if findRE "^[A-Z]_" . }}
                                {{ $appendixChapters = $appendixChapters | append . }}
                            {{ else }}
                                {{ $numberedChapters = $numberedChapters | append . }}
                            {{ end }}
                        {{ end }}
                        
                        {{/* Sort numbered chapters by extracting the number */}}
                        {{ $sortedNumbered := slice }}
                        {{ range seq 0 99 }}
                            {{ $num := . }}
                            {{ $paddedNum := printf "%02d_" $num }}
                            {{ $unpadded := printf "%d_" $num }}
                            {{ range $numberedChapters }}
                                {{ if or (hasPrefix . $paddedNum) (hasPrefix . $unpadded) }}
                                    {{ if not (in $sortedNumbered .) }}
                                        {{ $sortedNumbered = $sortedNumbered | append . }}
                                    {{ end }}
                                {{ end }}
                            {{ end }}
                        {{ end }}
                        
                        {{/* Sort appendix chapters alphabetically */}}
                        {{ $appendixChapters = sort $appendixChapters }}
                        
                        {{/* Combine: numbered first, then appendices */}}
                        {{ $chapterDirs = slice }}
                        {{ range $sortedNumbered }}
                            {{ $chapterDirs = $chapterDirs | append . }}
                        {{ end }}
                        {{ range $appendixChapters }}
                            {{ $chapterDirs = $chapterDirs | append . }}
                        {{ end }}
                        
                        {{ range $chapterDirs }}
                            {{ $chapterName := . }}
                            {{ $chapterPages := where $categoryPages "File.Dir" "eq" (printf "%s/%s/" $categoryName $chapterName) }}
                            {{ $chapterTitle := $chapterName | replaceRE "^([0-9]+|[A-Z])_" "$1. " | replaceRE "_" " " | title }}
                            
                            {{/* Chapter Folder */}}
                            <div class="chapter-item">
                                <div class="chapter-header" data-target="chapter-{{ $categoryName }}-{{ $chapterName }}">
                                    <span class="chapter-icon">‚ñ∂</span>
                                    {{ $isChapterIndex := and (eq $.Section $categoryName) (eq (path.Base (path.Dir $.File.Path)) $chapterName) (eq $.File.BaseFileName "00_index") }}
                                    <a href="/{{ $categoryName }}/{{ $chapterName | lower }}/00_index/" class="chapter-name-link {{ if $isChapterIndex }}active{{ end }}">
                                        <span class="chapter-name">{{ $chapterTitle }}</span>
                                    </a>
                                </div>
                                
                                <div class="chapter-content" id="chapter-{{ $categoryName }}-{{ $chapterName }}">
                                    {{/* Sort pages within chapter numerically */}}
                                    {{ $sortedPages := slice }}
                                    {{ $appendixPages := slice }}
                                    
                                    {{/* Separate numbered pages from appendix pages */}}
                                    {{ range $chapterPages }}
                                        {{ if not (eq .File.BaseFileName "00_index") }}
                                            {{ if findRE "^[A-Z]_" .File.BaseFileName }}
                                                {{ $appendixPages = $appendixPages | append . }}
                                            {{ else }}
                                                {{ $sortedPages = $sortedPages | append . }}
                                            {{ end }}
                                        {{ end }}
                                    {{ end }}
                                    
                                    {{/* Sort numbered pages by extracting the number */}}
                                    {{ $finalSortedPages := slice }}
                                    {{ range seq 0 99 }}
                                        {{ $num := . }}
                                        {{ $paddedNum := printf "%02d_" $num }}
                                        {{ $unpadded := printf "%d_" $num }}
                                        {{ range $sortedPages }}
                                            {{ if or (hasPrefix .File.BaseFileName $paddedNum) (hasPrefix .File.BaseFileName $unpadded) }}
                                                {{ if not (in $finalSortedPages .) }}
                                                    {{ $finalSortedPages = $finalSortedPages | append . }}
                                                {{ end }}
                                            {{ end }}
                                        {{ end }}
                                    {{ end }}
                                    
                                    {{/* Sort appendix pages alphabetically */}}
                                    {{ $appendixPages = sort $appendixPages "File.BaseFileName" }}
                                    
                                    {{/* Combine: numbered first, then appendices */}}
                                    {{ $allSortedPages := slice }}
                                    {{ range $finalSortedPages }}
                                        {{ $allSortedPages = $allSortedPages | append . }}
                                    {{ end }}
                                    {{ range $appendixPages }}
                                        {{ $allSortedPages = $allSortedPages | append . }}
                                    {{ end }}
                                    
                                    {{ range $allSortedPages }}
                                        {{ $fileName := .File.BaseFileName | replaceRE "^([0-9]+|[A-Z])_" "$1. " | replaceRE "_" " " | title }}
                                        <div class="file-item {{ if eq $.RelPermalink .RelPermalink }}active{{ end }}">
                                            <a href="{{ .RelPermalink }}" class="file-link">
                                                <span class="file-name">{{ $fileName }}</span>
                                                {{ if .Params.estimated_time }}
                                                    <span class="file-time">{{ .Params.estimated_time }}</span>
                                                {{ end }}
                                            </a>
                                        </div>
                                    {{ end }}
                                </div>
                            </div>
                        {{ end }}
                    </div>
                </div>
            {{ end }}
        {{ end }}
    </div>
</nav>

{{/* VSCode-style persistent navigation */}}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const STORAGE_KEY = 'vscode-nav-state';
    
    // Load saved expansion state
    function loadNavigationState() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            return saved ? JSON.parse(saved) : {};
        } catch (e) {
            return {};
        }
    }
    
    // Save expansion state
    function saveNavigationState(state) {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {
            // Ignore storage errors
        }
    }
    
    // Get current expansion state
    function getCurrentState() {
        const state = {};
        document.querySelectorAll('[data-target]').forEach(element => {
            const target = element.getAttribute('data-target');
            const content = document.getElementById(target);
            if (content) {
                state[target] = content.style.display === 'block';
            }
        });
        return state;
    }
    
    // Apply expansion state
    function applyNavigationState(state) {
        Object.keys(state).forEach(target => {
            const content = document.getElementById(target);
            const header = document.querySelector(`[data-target="${target}"]`);
            if (content && header) {
                const icon = header.querySelector('.folder-icon') || header.querySelector('.chapter-icon');
                if (state[target]) {
                    content.style.display = 'block';
                    if (icon) icon.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    if (icon) icon.textContent = '‚ñ∂';
                }
            }
        });
    }
    
    // Auto-expand hierarchy for current page
    function autoExpandCurrentHierarchy() {
        const currentSection = '{{ $.Section }}';
        const savedState = loadNavigationState();
        
        if (currentSection) {
            // Always expand current category (parent hierarchy)
            savedState[`category-${currentSection}`] = true;
            
            // Find active file and expand its chapter (parent hierarchy)
            const activeFile = document.querySelector('.file-item.active');
            if (activeFile) {
                const chapterContent = activeFile.closest('.chapter-content');
                if (chapterContent) {
                    savedState[chapterContent.id] = true;
                }
            }
        }
        
        return savedState;
    }
    
    // Toggle expansion and save state
    function toggleExpansion(icon, targetId) {
        const content = document.getElementById(targetId);
        if (!content) return;
        
        const isExpanded = content.style.display === 'block';
        
        if (isExpanded) {
            content.style.display = 'none';
            icon.textContent = '‚ñ∂';
        } else {
            content.style.display = 'block';
            icon.textContent = '‚ñº';
        }
        
        // Save current state
        saveNavigationState(getCurrentState());
    }
    
    // Initialize file tree with persistent state
    function initializeFileTree() {
        // Load and merge saved state with auto-expanded hierarchy
        const savedState = autoExpandCurrentHierarchy();
        applyNavigationState(savedState);
        saveNavigationState(savedState);
        
        // Handle folder icons (categories)
        document.querySelectorAll('.folder-icon').forEach(icon => {
            icon.addEventListener('click', function(e) {
                e.stopPropagation();
                const header = this.parentElement;
                const targetId = header.getAttribute('data-target');
                toggleExpansion(this, targetId);
            });
        });
        
        // Handle chapter icons
        document.querySelectorAll('.chapter-icon').forEach(icon => {
            icon.addEventListener('click', function(e) {
                e.stopPropagation();
                const header = this.parentElement;
                const targetId = header.getAttribute('data-target');
                toggleExpansion(this, targetId);
            });
        });
        
                 // Handle folder title clicks (navigate + auto-expand children)
         document.querySelectorAll('.folder-name-link').forEach(link => {
             link.addEventListener('click', function(e) {
                 // Let the navigation happen, but first expand immediate children
                 const header = this.closest('.folder-header');
                 const targetId = header.getAttribute('data-target');
                 const content = document.getElementById(targetId);
                 const icon = header.querySelector('.folder-icon');
                 
                 if (content && content.style.display !== 'block') {
                     content.style.display = 'block';
                     if (icon) icon.textContent = '‚ñº';
                     saveNavigationState(getCurrentState());
                 }
             });
         });
         
         // Handle chapter title clicks (navigate + auto-expand children)
         document.querySelectorAll('.chapter-name-link').forEach(link => {
             link.addEventListener('click', function(e) {
                 // Let the navigation happen, but first expand immediate children
                 const header = this.closest('.chapter-header');
                 const targetId = header.getAttribute('data-target');
                 const content = document.getElementById(targetId);
                 const icon = header.querySelector('.chapter-icon');
                 
                 if (content && content.style.display !== 'block') {
                     content.style.display = 'block';
                     if (icon) icon.textContent = '‚ñº';
                     saveNavigationState(getCurrentState());
                 }
             });
         });
    }
    
    initializeFileTree();
});
</script> 