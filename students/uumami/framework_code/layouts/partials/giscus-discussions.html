{{/* 
  Giscus Discussions Component - Framework Native
  Automatically integrates discussions with stable slug-based URLs
  Respects configuration from config.yml and per-content overrides
*/}}

{{ $discussions := .Site.Params.discussions }}
{{ $pageType := .Params.type }}
{{ $autoEnabled := in $discussions.auto_enable_for_types $pageType }}
{{ $excluded := in $discussions.exclude_types $pageType }}
{{ $explicitlyEnabled := ne .Params.discussions_enabled false }}

{{/* Check if discussions should be shown */}}
{{ if and $discussions.enabled (not $excluded) }}
  {{ if or $autoEnabled $explicitlyEnabled }}
    
    <section class="giscus-discussions" id="discussions">
      <div class="discussions-header">
        <h3>ðŸ’¬ Discussions</h3>
        <p class="discussions-subtitle">Join the conversation about this {{ $pageType }}</p>
      </div>
      
      <div class="giscus-container">
        {{/* Use stable slug for pathname mapping if available */}}
        {{ $pathname := "" }}
        {{ if and .Params.slug $discussions.slug_in_url }}
          {{ $pathname = printf "/discussions/%s" .Params.slug }}
        {{ else }}
          {{ $pathname = .RelPermalink }}
        {{ end }}
        
        <script src="https://giscus.app/client.js"
                data-repo="{{ $discussions.repository }}"
                data-repo-id="{{ $discussions.repository_id }}"
                data-category="{{ .Params.discussion_category | default $discussions.category }}"
                data-category-id="{{ $discussions.category_id }}"
                data-mapping="pathname"
                data-term="{{ $pathname }}"
                data-strict="0"
                data-reactions-enabled="{{ $discussions.reactions_enabled | default "1" }}"
                data-emit-metadata="{{ $discussions.emit_metadata | default "1" }}"
                data-input-position="{{ $discussions.input_position | default "top" }}"
                data-theme="{{ .Params.discussion_theme | default $discussions.theme }}"
                data-lang="en"
                data-loading="{{ $discussions.loading | default "lazy" }}"
                crossorigin="anonymous"
                async>
        </script>
        
        {{/* Hidden metadata for debugging */}}
        {{ if hugo.IsServer }}
          <div class="discussions-debug" style="display: none;">
            <p>Debug Info:</p>
            <ul>
              <li>Pathname: {{ $pathname }}</li>
              <li>Page Type: {{ $pageType }}</li>
              <li>Slug: {{ .Params.slug | default "none" }}</li>
              <li>Auto Enabled: {{ $autoEnabled }}</li>
              <li>Excluded: {{ $excluded }}</li>
            </ul>
          </div>
        {{ end }}
      </div>
    </section>
    
  {{ end }}
{{ end }}