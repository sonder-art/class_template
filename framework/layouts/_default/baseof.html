<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ============================================================================
         FRAMEWORK BASE LAYOUT - CORE HTML STRUCTURE
         Contains meta tags, external libraries, framework assets
         Theme-specific styling loaded via theme hooks
         ============================================================================ -->
    
    <!-- Basic Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ if .Title }}{{ .Title }} - {{ end }}{{ .Site.Title }}</title>
    <meta name="color-scheme" content="dark light">
    
    <!-- SEO and Description Meta Tags -->
    {{ if .Description }}
        <meta name="description" content="{{ .Description }}">
    {{ else if .Summary }}
        <meta name="description" content="{{ .Summary }}">
    {{ else if .Site.Params.description }}
        <meta name="description" content="{{ .Site.Params.description }}">
    {{ end }}
    
    <!-- FRAMEWORK CSS: Load framework structure and layout (PRIORITY ORDER) -->
    {{ $frameworkVariables := resources.Get "css/framework_variables.css" }}
    {{ if $frameworkVariables }}
        <link rel="stylesheet" href="{{ $frameworkVariables.RelPermalink }}">
    {{ end }}
    
    {{ $frameworkLayout := resources.Get "css/framework_layout.css" }}
    {{ if $frameworkLayout }}
        <link rel="stylesheet" href="{{ $frameworkLayout.RelPermalink }}">
    {{ end }}
    
    {{ $frameworkComponents := resources.Get "css/framework_components.css" }}
    {{ if $frameworkComponents }}
        <link rel="stylesheet" href="{{ $frameworkComponents.RelPermalink }}">
    {{ end }}
    
    <!-- Giscus Discussions Stylesheet -->
    {{ $giscusCSS := resources.Get "css/giscus-discussions.css" }}
    {{ if $giscusCSS }}
        <link rel="stylesheet" href="{{ $giscusCSS.RelPermalink }}">
    {{ end }}
    
    <!-- Framework Component Stylesheets -->
    {{ $pythonUIFrameworkCSS := resources.Get "components/python-ui.css" }}
    {{ if $pythonUIFrameworkCSS }}
        <link rel="stylesheet" href="{{ $pythonUIFrameworkCSS.RelPermalink }}">
    {{ end }}
    
    <!-- THEME HOOK: Load theme-specific stylesheets (AFTER framework) -->
    {{ block "theme-styles" . }}
        <!-- Evangelion Theme Core Styles -->
        {{ $themeCSS := resources.Get "theme/theme.css" }}
        {{ if $themeCSS }}
            <link rel="stylesheet" href="{{ $themeCSS.RelPermalink }}">
        {{ end }}
        
        <!-- Evangelion Theme Component Styles -->
        {{ $pythonUIThemeCSS := resources.Get "theme/components/python-ui.css" }}
        {{ if $pythonUIThemeCSS }}
            <link rel="stylesheet" href="{{ $pythonUIThemeCSS.RelPermalink }}">
        {{ end }}
        
        {{ $pythonEditorThemeCSS := resources.Get "theme/components/python-editor.css" }}
        {{ if $pythonEditorThemeCSS }}
            <link rel="stylesheet" href="{{ $pythonEditorThemeCSS.RelPermalink }}">
        {{ end }}
        
        {{ $floatingCopyThemeCSS := resources.Get "theme/components/floating-copy.css" }}
        {{ if $floatingCopyThemeCSS }}
            <link rel="stylesheet" href="{{ $floatingCopyThemeCSS.RelPermalink }}">
        {{ end }}
        
        {{ $dashboardThemeCSS := resources.Get "theme/components/dashboard.css" }}
        {{ if $dashboardThemeCSS }}
            <link rel="stylesheet" href="{{ $dashboardThemeCSS.RelPermalink }}">
        {{ end }}
        
        {{ $enrollmentThemeCSS := resources.Get "theme/components/enrollment.css" }}
        {{ if $enrollmentThemeCSS }}
            <link rel="stylesheet" href="{{ $enrollmentThemeCSS.RelPermalink }}">
        {{ end }}
        
        {{ $submissionThemeCSS := resources.Get "theme/components/submission-interface.css" }}
        {{ if $submissionThemeCSS }}
            <link rel="stylesheet" href="{{ $submissionThemeCSS.RelPermalink }}">
        {{ end }}
        
        {{ $gradingSyncThemeCSS := resources.Get "theme/components/grading-sync.css" }}
        {{ if $gradingSyncThemeCSS }}
            <link rel="stylesheet" href="{{ $gradingSyncThemeCSS.RelPermalink }}">
        {{ end }}
    {{ end }}
    
    <!-- External Libraries (Framework Dependencies) -->
    <!-- KaTeX for LaTeX Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
    
    <!-- Pyodide for Interactive Python Execution -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    
    <!-- Prism.js for Syntax Highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <!-- Supabase for Authentication -->
    {{ if .Site.Params.authentication.enabled }}
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Make auth config available to JavaScript
        window.authConfig = {
            enabled: {{ .Site.Params.authentication.enabled }},
            provider: "{{ .Site.Params.authentication.provider }}",
            supabase_url: "{{ .Site.Params.authentication.supabase_url }}",
            supabase_anon_key: "{{ .Site.Params.authentication.supabase_anon_key }}",
            login_redirect: "{{ .Site.Params.authentication.login_redirect }}",
            logout_redirect: "{{ .Site.Params.authentication.logout_redirect }}",
            protected_redirect: "{{ .Site.Params.authentication.protected_redirect }}",
            login_icon: "{{ .Site.Params.authentication.login_icon }}",
            logout_icon: "{{ .Site.Params.authentication.logout_icon }}",
            base_url: "{{ .Site.BaseURL | strings.TrimSuffix "/" }}"
        };
    </script>
    {{ end }}
    
    <!-- THEME HOOK: Load theme-specific fonts and external resources -->
    {{ block "theme-fonts" . }}
        <!-- Google Fonts - can be overridden by themes -->
        <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    {{ end }}
    

    
    <!-- THEME HOOK: Additional theme scripts -->
    {{ block "theme-scripts" . }}
        <!-- Themes can add additional scripts here -->
    {{ end }}
</head>
<body class="site-container nav-full{{ if .Site.Params.default_font }} font-{{ .Site.Params.default_font }}{{ end }}{{ if .Site.Params.high_contrast }} high-contrast{{ end }}">
    
    <!-- ============================================================================
         FRAMEWORK SITE STRUCTURE
         Navigation, header, main content, and footer layout
         Themes control styling, framework controls structure
         ============================================================================ -->
    
    <!-- Mobile Navigation Toggle Button -->
    <button class="nav-toggle-btn" 
            id="navToggle" 
            aria-label="Toggle navigation menu"
            aria-expanded="true"
            aria-controls="siteNavigation">
        <span class="nav-toggle-icon">
            <span class="nav-toggle-line"></span>
            <span class="nav-toggle-line"></span>
            <span class="nav-toggle-line"></span>
        </span>
    </button>
    
    <!-- Mobile Navigation Overlay -->
    <div class="nav-overlay" id="navOverlay"></div>
    
    <!-- Site Header with Breadcrumbs and Main Navigation -->
    <header class="site-header">
        <div class="header-content">
            <h1><a href="{{ .Site.BaseURL }}">{{ .Site.Title }}</a></h1>
            
            <!-- Breadcrumb Navigation (shows when sidebar is collapsed) -->
            <nav class="breadcrumb-nav" id="breadcrumbNav">
                <span class="breadcrumb-current"></span>
            </nav>
            
            <nav class="main-nav">
                {{ range .Site.Menus.main }}
                    <a href="{{ .URL }}" {{ if $.IsMenuCurrent "main" . }}class="active"{{ end }}>{{ .Name }}</a>
                {{ end }}
            </nav>
            
            <!-- Search Bar -->
            <div class="header-search">
                <input type="search" 
                       id="headerSearch" 
                       placeholder="Search content..." 
                       aria-label="Search site content"
                       autocomplete="off">
                <button type="button" id="searchClear" class="search-clear" title="Clear search">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
        </div>
    </header>
    
    <!-- Site Sidebar Navigation -->
    <aside class="site-sidebar" id="siteNavigation" role="navigation">
        {{ block "sidebar" . }}
            {{ partial "sidebar-nav.html" . }}
        {{ end }}
    </aside>
    
    <!-- Main Content Area -->
    <main class="site-main content">
        <div class="content-wrapper">
            <article class="main-content">
                {{ block "main" . }}{{ end }}
            </article>
            
            <!-- Table of Contents Sidebar -->
            <aside class="toc-sidebar" id="tocSidebar">
                <div class="toc-header">
                    <h3>Contents</h3>
                </div>
                <nav class="toc-nav" id="tocNav">
                    <!-- TOC will be generated by JavaScript -->
                </nav>
            </aside>
        </div>
    </main>
    
    <!-- Site Footer -->
    <footer class="site-footer">
        <p>&copy; {{ now.Year }} {{ .Site.Params.course_name }} - {{ .Site.Params.professor_name }}</p>
        {{ if .Site.Params.contact_policy }}
            <p>{{ .Site.Params.contact_policy }}</p>
        {{ end }}
    </footer>
    
    <!-- Framework Components -->
    <!-- Floating Copy Button Component -->
    <button class="floating-copy-button" id="floatingCopyBtn" title="Copy pure markdown content + code outputs">
        📝
    </button>

    <!-- THEME HOOK: Additional theme body elements -->
    {{ block "theme-body" . }}
        <!-- Themes can add additional body elements here -->
    {{ end }}

    <!-- Framework JavaScript Modules (loaded at end of body for proper DOM access) -->
    {{ $navigationJS := resources.Get "js/navigation.js" }}
    {{ if $navigationJS }}
        <script src="{{ $navigationJS.RelPermalink }}"></script>
    {{ end }}
    
    {{ $mathRenderingJS := resources.Get "js/math-rendering.js" }}
    {{ if $mathRenderingJS }}
        <script src="{{ $mathRenderingJS.RelPermalink }}"></script>
    {{ end }}
    
    {{ $pythonEnvJS := resources.Get "js/python-environment.js" }}
    {{ if $pythonEnvJS }}
        <script src="{{ $pythonEnvJS.RelPermalink }}"></script>
    {{ end }}
    
    {{ $floatingCopyJS := resources.Get "js/floating-copy.js" }}
    {{ if $floatingCopyJS }}
        <script src="{{ $floatingCopyJS.RelPermalink }}"></script>
    {{ end }}
    
    {{ $sidebarNavigationJS := resources.Get "js/sidebar-navigation.js" }}
    {{ if $sidebarNavigationJS }}
        <script src="{{ $sidebarNavigationJS.RelPermalink }}"></script>
    {{ end }}
    
    {{ $headerSearchJS := resources.Get "js/header-search.js" }}
    {{ if $headerSearchJS }}
        <script src="{{ $headerSearchJS.RelPermalink }}"></script>
    {{ end }}
    
    {{ $tocJS := resources.Get "js/table-of-contents.js" }}
{{ if $tocJS }}
    <script src="{{ $tocJS.RelPermalink }}"></script>
{{ end }}

    {{ if .Site.Params.authentication.enabled }}
    {{ $authUtilsJS := resources.Get "js/auth-utils.js" }}
    {{ if $authUtilsJS }}
        <script src="{{ $authUtilsJS.RelPermalink }}"></script>
    {{ end }}
    {{ $authClientJS := resources.Get "js/auth-client.js" }}
    {{ if $authClientJS }}
        <script src="{{ $authClientJS.RelPermalink }}"></script>
    {{ end }}
    {{ $supabaseAuthJS := resources.Get "js/supabase-auth.js" }}
    {{ if $supabaseAuthJS }}
        <script src="{{ $supabaseAuthJS.RelPermalink }}"></script>
    {{ end }}

    <!-- Framework Configuration (Auto-generated class context) -->
    <script src="{{ .Site.BaseURL }}js/framework-config.js"></script>

    <!-- Grading System JavaScript (Students) -->
    {{ $itemSubmissionJS := resources.Get "js/item-submission.js" }}
    {{ if $itemSubmissionJS }}
        <script src="{{ $itemSubmissionJS.RelPermalink }}"></script>
    {{ end }}

    <!-- Grading System JavaScript (Professors) -->
    {{ $gradingJS := resources.Get "js/grading.js" }}
    {{ if $gradingJS }}
        <script src="{{ $gradingJS.RelPermalink }}"></script>
    {{ end }}
    
    <script>
    // Auth Navigation Management
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🔗 Sidebar Auth Navigation initialized');
        
        // Get navigation elements (updated IDs for sidebar)
        const authToggleBtn = document.getElementById('navAuthToggleBtn');
        const dashboardBtn = document.getElementById('navDashboardBtn');
        
        if (!authToggleBtn) {
            console.warn('⚠️ Auth navigation buttons not found');
            return;
        }
        
        // Setup auth toggle button handler
        authToggleBtn.addEventListener('click', function() {
            if (window.authState?.isAuthenticated) {
                // Logout
                if (window.supabaseAuth && window.supabaseAuth.logout) {
                    window.supabaseAuth.logout();
                }
            } else {
                // Login
                if (window.supabaseAuth && window.supabaseAuth.login) {
                    window.supabaseAuth.login();
                }
            }
        });
        
        // Listen for auth state changes
        window.addEventListener('authStateChanged', function(event) {
            console.log('🎯 Auth state changed event received:', event.detail);
            setTimeout(updateSidebarAuthNavigation, 100);
        });
        
        // Initial setup when page loads - multiple attempts for reliability
        setTimeout(updateSidebarAuthNavigation, 500);
        setTimeout(updateSidebarAuthNavigation, 1000);
        setTimeout(updateSidebarAuthNavigation, 2000);
        
        // Also listen for general auth events that might not trigger our custom event
        if (window.authState?.client) {
            window.authState.client.auth.onAuthStateChange((event, session) => {
                console.log('🔒 Supabase auth state change:', event, session ? 'session exists' : 'no session');
                setTimeout(updateSidebarAuthNavigation, 200);
            });
        } else {
            // If client isn't ready yet, check again later
            setTimeout(() => {
                if (window.authState?.client) {
                    window.authState.client.auth.onAuthStateChange((event, session) => {
                        console.log('🔒 Supabase auth state change (delayed):', event, session ? 'session exists' : 'no session');
                        setTimeout(updateSidebarAuthNavigation, 200);
                    });
                }
            }, 3000);
        }
    });
    
    /**
     * Update sidebar navigation based on current auth state
     */
    function updateSidebarAuthNavigation() {
        const authToggleBtn = document.getElementById('navAuthToggleBtn');
        const dashboardBtn = document.getElementById('navDashboardBtn');
        const userStatusText = document.getElementById('userStatusText');
        
        if (!authToggleBtn) {
            console.warn('⚠️ Navigation auth button not found');
            return;
        }
        
        const user = window.authState?.user;
        const userContext = window.authState?.userContext;
        const isAuthenticated = window.authState?.isAuthenticated;
        const isLoading = window.authState?.isLoading || false;
        
        console.log('🔄 Updating sidebar auth navigation:', { 
            user: !!user, 
            userContext: userContext, 
            isAuthenticated, 
            isLoading,
            timestamp: new Date().toISOString()
        });
        
        // Update user status display with better error handling
        if (userStatusText) {
            try {
                if (isLoading) {
                    userStatusText.textContent = '🔄 Loading...';
                } else if (isAuthenticated && user) {
                    const email = user.email || 'Unknown';
                    const role = userContext?.role || 'Member';
                    const isMember = userContext?.is_member === true;
                    const status = isMember ? '✅' : '❌';
                    userStatusText.textContent = `${status} ${email} (${role})`;
                } else {
                    userStatusText.textContent = '❌ Not logged in';
                }
            } catch (error) {
                console.error('Error updating user status:', error);
                userStatusText.textContent = '⚠️ Status error';
            }
        }
        
        // Update auth toggle button
        try {
            if (isLoading) {
                authToggleBtn.textContent = 'Loading...';
                authToggleBtn.title = 'Please wait...';
                authToggleBtn.disabled = true;
            } else if (isAuthenticated && user) {
                // User is logged in
                authToggleBtn.textContent = 'Logout';
                authToggleBtn.title = 'Logout';
                authToggleBtn.disabled = false;
            } else {
                // User is not logged in
                authToggleBtn.textContent = 'Login';
                authToggleBtn.title = 'Login to access features';
                authToggleBtn.disabled = false;
            }
        } catch (error) {
            console.error('Error updating auth button:', error);
        }
        
        // Update navigation buttons - simplified without enroll button
        try {
            if (isAuthenticated && user && !isLoading) {
                // Always show dashboard for authenticated users
                if (dashboardBtn) {
                    dashboardBtn.style.display = 'block';
                }
            } else {
                // User is not authenticated or still loading - hide dashboard
                if (dashboardBtn) {
                    dashboardBtn.style.display = 'none';
                }
            }
        } catch (error) {
            console.error('Error updating navigation buttons:', error);
        }
    }
    </script>
    {{ end }}

</body>
</html> 