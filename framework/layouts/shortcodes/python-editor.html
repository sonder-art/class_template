{{/*
Unified Python Editor Component
Usage: 
  {{< python-editor >}}code{{< /python-editor >}}                    # Full width layout
  {{< python-editor layout="constrained" >}}code{{< /python-editor >}} # Constrained for two-column
*/}}

{{ $layout := .Get "layout" | default "full" }}
{{ $editorId := printf "python-editor-%d" .Ordinal }}

<div class="python-editor-wrapper" data-layout="{{ $layout }}">
  <div class="python-editor-container" id="{{ $editorId }}">
    
    <!-- Header with title and controls -->
    <div class="python-editor-header">
      <div class="editor-title">
        <span class="editor-icon">üêç</span>
        <span class="editor-text">Interactive Python</span>
        {{ if eq $layout "constrained" }}
          <span class="editor-badge">Lesson Mode</span>
        {{ else }}
          <span class="editor-badge">Full Width</span>
        {{ end }}
      </div>
      <div class="editor-controls">
        <button class="run-button" onclick="runPythonCode('{{ $editorId }}')" 
                title="Run Python Code (Ctrl+Enter)">
          <span class="button-icon">‚ñ∂</span>
          <span class="button-text">Run</span>
        </button>
        <button class="copy-code-button" onclick="copyPythonCode('{{ $editorId }}')" 
                title="Copy Code">
          <span class="button-icon">üìã</span>
          <span class="button-text">Copy</span>
        </button>
        <button class="clear-button" onclick="clearPythonEditorOutput('{{ $editorId }}')" 
                title="Clear Output">
          <span class="button-icon">üóë</span>
          <span class="button-text">Clear</span>
        </button>
      </div>
    </div>
    
    <!-- Code input area -->
    <div class="python-editor-input">
      <div class="code-editor" 
           contenteditable="true" 
           spellcheck="false"
           data-placeholder="# Write your Python code here...
print('Hello, World!')

# Press Ctrl+Enter to run">{{ .Inner }}</div>
    </div>
    
    <!-- Output area (hidden in lesson layouts) -->
    <div class="python-editor-output" id="output-{{ $editorId }}"></div>
    
  </div>
</div>



<script>
// Unified Python execution system
function runPythonCode(editorId) {
  const container = document.getElementById(editorId);
  if (!container) {
    console.error('Editor container not found:', editorId);
    return;
  }
  
  const codeEditor = container.querySelector('.code-editor');
  let outputArea = container.querySelector('.python-editor-output');
  
  // For lesson layout, use the shared output area
  const lessonContainer = container.closest('.python-lesson-container');
  if (lessonContainer) {
    // Try multiple selectors to find the shared output area
    outputArea = lessonContainer.querySelector(':scope > .python-editor-output') || 
                 lessonContainer.querySelector('.python-editor-output:not([id^="output-"])') ||
                 lessonContainer.querySelector('[id^="lesson-output-"]');
    
    console.log('Lesson container found:', lessonContainer);
    console.log('Shared output area found:', outputArea);
    
    if (!outputArea) {
      console.error('Shared output area not found in lesson layout');
      return;
    }
  }
  
  if (!codeEditor || !outputArea) {
    console.error('Code editor or output area not found');
    return;
  }
  
  // Extract code with proper line break preservation
  let code = '';
  
  if (codeEditor.innerText) {
    // innerText preserves line breaks better than textContent
    code = codeEditor.innerText;
  } else if (codeEditor.textContent) {
    code = codeEditor.textContent;
  }
  
  // Ensure line breaks are properly normalized
  code = code.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  
  console.log('Code to execute:', JSON.stringify(code)); // Debug: show actual code with line breaks
  
  // Clear previous output and show output area
  outputArea.textContent = '';
  outputArea.style.display = 'block';
  
  // Show loading indicator
  outputArea.innerHTML = '<span style="color: var(--python-warning);">üîÑ Running Python...</span>';
  
  try {
    // Check if Pyodide is ready
    if (window.pyodide && window.pyodideReady === true) {
      // Use real Python execution
      executePythonCode();
    } else if (typeof window.loadPyodide !== 'undefined' && !window.pyodide) {
      // Load Pyodide if available but not initialized
      outputArea.innerHTML = '<span style="color: var(--python-warning);">üîÑ Loading Python environment...</span>';
      
      window.loadPyodide().then((pyodide) => {
        window.pyodide = pyodide;
        window.pyodideReady = true;
        console.log('‚úÖ Python environment loaded');
        
        // Retry execution
        setTimeout(() => runPythonCode(editorId), 100);
      }).catch((error) => {
        console.error('‚ùå Failed to load Python environment:', error);
        outputArea.innerHTML = '<span class="error">üö® Failed to load Python environment</span>';
      });
      
      return;
    } else if (window.pyodideReady === false) {
      // Pyodide is still loading
      outputArea.innerHTML = '<span style="color: var(--python-warning);">‚è≥ Python environment starting up...</span>';
      setTimeout(() => runPythonCode(editorId), 1000);
      return;
    } else {
      // No Python environment available
      outputArea.innerHTML = '<span class="error">üö® Python environment not available</span>';
      console.error('Python environment not found');
      return;
    }
  } catch (error) {
    console.error('Error in Python execution:', error);
    outputArea.innerHTML = `<span class="error">üö® Error: ${error.message}</span>`;
  }
  
  // Clean Python execution function
  function executePythonCode() {
    try {
      const pyodide = window.pyodide;
      
      // Capture output
      pyodide.runPython(`
import sys
import io
sys.stdout = io.StringIO()
sys.stderr = io.StringIO()
      `);
      
      // Execute user code
      pyodide.runPython(code);
      
      // Get results
      const stdout = pyodide.runPython('sys.stdout.getvalue()');
      const stderr = pyodide.runPython('sys.stderr.getvalue()');
      
      // Display results
      outputArea.innerHTML = '';
      
      if (stdout) {
        const successDiv = document.createElement('div');
        successDiv.className = 'success';
        successDiv.textContent = stdout;
        outputArea.appendChild(successDiv);
      }
      
      if (stderr) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.textContent = 'üö® Error: ' + stderr;
        outputArea.appendChild(errorDiv);
      }
      
      if (!stdout && !stderr) {
        outputArea.innerHTML = '<span class="success">‚úÖ Code executed successfully</span>';
      }
      
      // Add copy button to output if there's content
      if (stdout || stderr) {
        const copyButton = document.createElement('button');
        copyButton.className = 'copy-output-button';
        copyButton.innerHTML = '<span>üìã</span> Copy Output';
        
        // Store outputArea reference and add click handler
        copyButton.addEventListener('click', function(e) {
          e.preventDefault();
          copyPythonEditorOutput(outputArea);
        });
        
        copyButton.style.marginTop = '8px';
        copyButton.style.display = 'block';
        outputArea.appendChild(copyButton);
      }
      
    } catch (error) {
      outputArea.innerHTML = `<span class="error">üö® Python Error: ${error.message}</span>`;
      console.error('Python execution error:', error);
    }
  }
}

function clearPythonEditorOutput(editorId) {
  const container = document.getElementById(editorId);
  if (!container) return;
  
  // Handle both individual and lesson layout output areas
  const lessonContainer = container.closest('.python-lesson-container');
  if (lessonContainer) {
    // Clear shared output area
    const sharedOutput = lessonContainer.querySelector(':scope > .python-editor-output');
    if (sharedOutput) {
      sharedOutput.innerHTML = '<div class="output-placeholder">Output will appear here when you run the Python code...</div>';
      console.log('‚úÖ Cleared shared output area');
    }
  } else {
    // Clear individual output area
    const outputArea = container.querySelector('.python-editor-output');
    if (outputArea) {
      outputArea.textContent = '';
      outputArea.style.display = 'none';
      console.log('‚úÖ Cleared individual output area');
    }
  }
}

// Copy functions
function copyPythonCode(editorId) {
  const container = document.getElementById(editorId);
  if (!container) return;
  
  const codeEditor = container.querySelector('.code-editor');
  if (!codeEditor) return;
  
  const code = codeEditor.innerText || codeEditor.textContent;
  
  navigator.clipboard.writeText(code).then(() => {
    console.log('‚úÖ Code copied to clipboard');
    
    // Visual feedback
    const button = container.querySelector('.copy-code-button');
    if (button) {
      const originalText = button.innerHTML;
      button.innerHTML = '<span class="button-icon">‚úÖ</span><span class="button-text">Copied!</span>';
      setTimeout(() => {
        button.innerHTML = originalText;
      }, 2000);
    }
  }).catch(err => {
    console.error('Failed to copy code:', err);
  });
}

function copyPythonEditorOutput(outputArea) {
  if (!outputArea) return;
  
  // Get all text content except the copy button
  const textElements = outputArea.querySelectorAll('.success, .error');
  let text = '';
  textElements.forEach(el => {
    text += el.textContent + '\n';
  });
  
  if (!text.trim()) {
    text = outputArea.textContent.replace(/üìã\s*Copy Output/g, '').trim();
  }
  
  navigator.clipboard.writeText(text).then(() => {
    // Visual feedback
    const button = outputArea.querySelector('.copy-output-button');
    if (button) {
      const originalText = button.innerHTML;
      button.innerHTML = '<span>‚úÖ</span> Copied!';
      setTimeout(() => {
        button.innerHTML = originalText;
      }, 2000);
    }
  }).catch(err => {
    console.error('Failed to copy output:', err);
  });
}

// TODO: Implement syntax highlighting with a safe approach (textarea + overlay)

// Keyboard shortcuts and initialization
document.addEventListener('DOMContentLoaded', function() {
  // Initialize editors with proper expansion behavior
  setTimeout(() => {
    document.querySelectorAll('.code-editor').forEach(editor => {
      const wrapper = editor.closest('.python-editor-wrapper');
      const isFullWidth = wrapper && wrapper.dataset.layout !== 'constrained';
      
      // Auto-expansion for full-width editors only
      if (isFullWidth) {
        function adjustHeight() {
          // Simple height adjustment without conflicts
          if (editor.scrollHeight > editor.clientHeight) {
            editor.style.height = editor.scrollHeight + 'px';
          }
        }
        
        // Adjust on input with debouncing
        editor.addEventListener('input', function() {
          clearTimeout(editor.adjustTimeout);
          editor.adjustTimeout = setTimeout(adjustHeight, 100);
        });
        
        // Initial adjustment
        setTimeout(adjustHeight, 100);
      }
      
      // Handle paste events - plain text only
      editor.addEventListener('paste', function(e) {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text');
        
        // Insert plain text
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          range.deleteContents();
          range.insertNode(document.createTextNode(paste));
          range.collapse(false);
        }
        
        // Adjust height after paste for full-width editors
        if (isFullWidth) {
          setTimeout(() => {
            if (editor.scrollHeight > editor.clientHeight) {
              editor.style.height = editor.scrollHeight + 'px';
            }
          }, 10);
        }
      });
    });
  }, 100);
  
  // Add keyboard shortcuts for all Python editors
  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'Enter') {
      const activeEditor = document.activeElement;
      if (activeEditor && activeEditor.classList.contains('code-editor')) {
        e.preventDefault();
        const container = activeEditor.closest('.python-editor-container');
        if (container) {
          runPythonCode(container.id);
        }
      }
    }
  });
  
  // Initialize Python environment status
  console.log('üêç Python Editor initialized');
  
  if (window.pyodide && window.pyodideReady) {
    console.log('‚úÖ Python environment ready');
  } else {
    console.log('‚è≥ Python environment will be loaded when needed');
  }
});
</script> 